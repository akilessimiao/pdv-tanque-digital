-- Tabela de ativação
CREATE TABLE IF NOT EXISTS activation_keys (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  serial_key TEXT UNIQUE NOT NULL,
  is_used BOOLEAN DEFAULT false,
  client_id UUID,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de empresas
CREATE TABLE IF NOT EXISTS companies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_name TEXT NOT NULL,
  cnpj TEXT,
  phone TEXT,
  address TEXT,
  logo_url TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de usuários
CREATE TABLE IF NOT EXISTS users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  username TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  role TEXT CHECK (role IN ('admin', 'operator')) DEFAULT 'operator',
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de produtos (estrutura correta do PDV)
CREATE TABLE IF NOT EXISTS products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  code TEXT,
  barcode TEXT,
  name TEXT NOT NULL,
  cost_price DECIMAL(10,2) DEFAULT 0,
  price DECIMAL(10,2) NOT NULL,
  stock INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de caixa
CREATE TABLE IF NOT EXISTS cash_registers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  opening_balance DECIMAL(10,2) DEFAULT 0,
  is_open BOOLEAN DEFAULT true,
  opened_at TIMESTAMP DEFAULT NOW(),
  closed_at TIMESTAMP
);

-- Tabela de vendas
CREATE TABLE IF NOT EXISTS sales (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  sale_number INTEGER NOT NULL,
  receipt_serial TEXT DEFAULT '111-000001',
  total_amount DECIMAL(10,2) NOT NULL,
  payment_cash DECIMAL(10,2) DEFAULT 0,
  payment_pix DECIMAL(10,2) DEFAULT 0,
  payment_card DECIMAL(10,2) DEFAULT 0,
  change_amount DECIMAL(10,2) DEFAULT 0,
  customer_name TEXT,
  customer_document TEXT,
  operator_id UUID REFERENCES users(id) ON DELETE SET NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Serial de ativação (ÚNICO DADO INICIAL)
INSERT INTO activation_keys (serial_key, is_used) 
VALUES ('TQD-DEMO-2024', false)
ON CONFLICT (serial_key) DO NOTHING;
