-- ========================================
-- PDV TANQUE DIGITAL - BANCO DE DADOS
-- ========================================

-- Tabela de chaves de ativação
CREATE TABLE activation_keys (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  serial_key TEXT UNIQUE NOT NULL,
  is_used BOOLEAN DEFAULT false,
  client_id UUID,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de empresas
CREATE TABLE companies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_name TEXT NOT NULL,
  cnpj TEXT,
  phone TEXT,
  address TEXT,
  logo_url TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de usuários (admin + operadores)
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  username TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  role TEXT CHECK (role IN ('admin', 'operator')) DEFAULT 'operator',
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de fornecedores
CREATE TABLE suppliers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  contact_person TEXT,
  phone TEXT,
  email TEXT,
  address TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de produtos
CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  code TEXT,
  barcode TEXT,
  name TEXT NOT NULL,
  cost_price DECIMAL(10,2) DEFAULT 0,
  price DECIMAL(10,2) NOT NULL,
  stock INTEGER DEFAULT 0,
  supplier_id UUID REFERENCES suppliers(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de movimentação de estoque
CREATE TABLE stock_movements (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  product_id UUID REFERENCES products(id) ON DELETE SET NULL,
  movement_type TEXT CHECK (movement_type IN ('entrada', 'saida', 'ajuste')) NOT NULL,
  quantity INTEGER NOT NULL,
  cost_price DECIMAL(10,2),
  reason TEXT,
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de caixas registradores
CREATE TABLE cash_registers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  opening_balance DECIMAL(10,2) DEFAULT 0,
  closing_balance DECIMAL(10,2),
  initial_change DECIMAL(10,2) DEFAULT 0,
  is_open BOOLEAN DEFAULT true,
  opened_at TIMESTAMP DEFAULT NOW(),
  closed_at TIMESTAMP
);

-- Tabela de movimentações do caixa
CREATE TABLE cash_movements (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  cash_register_id UUID REFERENCES cash_registers(id) ON DELETE CASCADE,
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  movement_type TEXT CHECK (movement_type IN ('venda', 'sangria', 'suprimento', 'fechamento')) NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  description TEXT,
  authorized_by UUID REFERENCES users(id) ON DELETE SET NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de vendas
CREATE TABLE sales (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  sale_number INTEGER NOT NULL,
  receipt_serial TEXT DEFAULT '111-000001',
  total_amount DECIMAL(10,2) NOT NULL,
  payment_cash DECIMAL(10,2) DEFAULT 0,
  payment_pix DECIMAL(10,2) DEFAULT 0,
  payment_card DECIMAL(10,2) DEFAULT 0,
  change_amount DECIMAL(10,2) DEFAULT 0,
  customer_name TEXT,
  customer_document TEXT,
  operator_id UUID REFERENCES users(id) ON DELETE SET NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de itens da venda
CREATE TABLE sale_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  sale_id UUID REFERENCES sales(id) ON DELETE CASCADE,
  product_name TEXT NOT NULL,
  quantity INTEGER NOT NULL,
  unit_price DECIMAL(10,2) NOT NULL,
  total_price DECIMAL(10,2) NOT NULL
);

-- Tabela de cupons
CREATE TABLE receipts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  sale_id UUID REFERENCES sales(id) ON DELETE CASCADE,
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  receipt_type TEXT CHECK (receipt_type IN ('fiscal', 'nao_fiscal')),
  receipt_html TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de leitura Z
CREATE TABLE z_readings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  cash_register_id UUID REFERENCES cash_registers(id) ON DELETE SET NULL,
  reading_number INTEGER NOT NULL,
  opening_time TIMESTAMP NOT NULL,
  closing_time TIMESTAMP NOT NULL,
  total_sales INTEGER DEFAULT 0,
  total_amount DECIMAL(10,2) NOT NULL,
  cash_amount DECIMAL(10,2) DEFAULT 0,
  pix_amount DECIMAL(10,2) DEFAULT 0,
  card_amount DECIMAL(10,2) DEFAULT 0,
  total_change DECIMAL(10,2) DEFAULT 0,
  withdrawals DECIMAL(10,2) DEFAULT 0,
  final_balance DECIMAL(10,2) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ========================================
-- DADOS INICIAIS
-- ========================================

-- Serial de ativação de exemplo
INSERT INTO activation_keys (serial_key, is_used) 
VALUES ('TQD-DEMO-2024', false);

-- ⚠️ REMOVI OS PRODUTOS DE EXEMPLO (causavam erro de foreign key)
-- Os produtos serão adicionados depois que o cliente ativar o sistema

-- Fim do script
