<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDV Tanque Digital - Login</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
    .container { background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); width: 100%; max-width: 450px; padding: 40px; text-align: center; animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .logo-icon { width: 80px; height: 80px; background: linear-gradient(135deg, #1a73e8 0%, #0d62d9 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; color: white; font-size: 36px; box-shadow: 0 8px 20px rgba(26, 115, 232, 0.4); }
    h1 { font-size: 28px; color: #1a73e8; margin-bottom: 8px; font-weight: 700; }
    .logo-subtitle { color: #666; font-size: 15px; margin-top: 5px; }
    .login-tabs { display: flex; gap: 10px; margin-bottom: 30px; background: #f8f9fa; padding: 5px; border-radius: 12px; box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05); }
    .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; color: #666; transition: all 0.3s ease; }
    .tab-btn:hover { background: rgba(26, 115, 232, 0.1); color: #1a73e8; }
    .tab-btn.active { background: linear-gradient(135deg, #1a73e8 0%, #0d62d9 100%); color: white; box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3); }
    .form-group { margin-bottom: 20px; text-align: left; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; }
    .form-group input { width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; transition: all 0.3s ease; }
    .form-group input:focus { outline: none; border-color: #1a73e8; box-shadow: 0 0 0 4px rgba(26, 115, 232, 0.1); }
    .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-login { background: linear-gradient(135deg, #1a73e8 0%, #0d62d9 100%); color: white; box-shadow: 0 4px 15px rgba(26, 115, 232, 0.4); }
    .btn-login:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(26, 115, 232, 0.5); }
    .btn-activate { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4); }
    .btn-activate:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5); }
    .activation-info { background: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; font-size: 14px; color: #2e7d32; }
    .login-footer { margin-top: 35px; padding-top: 25px; border-top: 1px solid #eee; }
    .login-footer p { margin: 8px 0; color: #666; font-size: 14px; }
    .version { color: #999; font-size: 13px; margin-top: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-icon">
      <i class="fas fa-gas-pump"></i>
    </div>
    <h1>PDV Tanque Digital</h1>
    <p class="logo-subtitle">Sistema Completo de Gest√£o de Vendas</p>
    
    <div class="login-tabs">
      <button class="tab-btn active" id="loginTabBtn">Login</button>
      <button class="tab-btn" id="activateTabBtn">Ativar</button>
    </div>

    <div id="loginTab">
      <div class="form-group">
        <label>Usu√°rio</label>
        <input type="text" id="username" placeholder="admin" value="admin">
      </div>
      <div class="form-group">
        <label>Senha</label>
        <input type="password" id="password" placeholder="admin123" value="admin123">
      </div>
      <button class="btn btn-login" id="loginBtn">
        <i class="fas fa-sign-in-alt"></i> ENTRAR
      </button>
    </div>
    
    <div id="activateTab" style="display:none">
      <div class="activation-info">
        <p><i class="fas fa-info-circle"></i> Digite o c√≥digo de ativa√ß√£o: <strong>TQD-DEMO-2024</strong></p>
      </div>
      <div class="form-group">
        <label>C√≥digo de Ativa√ß√£o</label>
        <input type="text" id="serialKey" placeholder="TQD-DEMO-2024" value="TQD-DEMO-2024" maxlength="14">
      </div>
      <button class="btn btn-activate" id="activateBtn">
        <i class="fas fa-key"></i> ATIVAR LICEN√áA
      </button>
    </div>
    
    <div class="login-footer">
      <p><i class="fas fa-shield-alt"></i> Sistema seguro e protegido</p>
      <p class="version">Vers√£o 3.1 ‚Ä¢ Tanque Digital ¬© 2024</p>
      <p><strong style="color: #1a73e8;">üìç Suporte Local: Natal/RN - Resposta em minutos!</strong></p>
    </div>
  </div>
    <script type="module">
      import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
      
      // CREDENCIAIS DO NOVO SUPABASE
      const SUPABASE_URL = 'https://wohhcexqaqpfokhuvkqk.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_q7PLJV2NAyptuce8vtSSpQ_4WcP6kcd';
      
      window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
    <script>
    // Fun√ß√µes de UI
    function showTab(tab) {
      document.getElementById('loginTab').style.display = tab === 'login' ? 'block' : 'none';
      document.getElementById('activateTab').style.display = tab === 'activate' ? 'block' : 'none';
      document.getElementById('loginTabBtn').classList.toggle('active', tab === 'login');
      document.getElementById('activateTabBtn').classList.toggle('active', tab === 'activate');
    }

    // Eventos
    document.getElementById('loginTabBtn').addEventListener('click', () => showTab('login'));
    document.getElementById('activateTabBtn').addEventListener('click', () => showTab('activate'));
    document.getElementById('loginBtn').addEventListener('click', login);
    document.getElementById('activateBtn').addEventListener('click', activate);

    // Login
    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      
      if (!username || !password) {
        alert('Preencha todos os campos!');
        return;
      }
      
      try {
        const { data, error } = await supabase
          .from('users')
          .select('id, company_id, username, role')
          .eq('username', username)
          .eq('password_hash', password)
          .single();
        
        if (error || !data) {
          alert('Usu√°rio ou senha inv√°lidos!\nTente: admin / admin123');
          return;
        }
        
        localStorage.setItem('userId', data.id);
        localStorage.setItem('companyId', data.company_id);
        localStorage.setItem('username', data.username);
        localStorage.setItem('role', data.role);
        
        window.location.href = 'dashboard.html';
      } catch (err) {
        console.error('Erro no login:', err);
        alert('Erro ao conectar ao servidor. Verifique o console (F12).');
      }
    }

        // Ativa√ß√£o - VERS√ÉO ATUALIZADA PARA NOVO BANCO
    async function activate() {
      const serial = document.getElementById('serialKey').value.toUpperCase().replace(/[^A-Z0-9]/g, '');
      
      if (serial !== 'TQD-DEMO-2024') {
        alert('C√≥digo inv√°lido!\nUse exatamente: TQD-DEMO-2024');
        return;
      }
      
      try {
        console.log('üîë Iniciando ativa√ß√£o...');
        
        // 1. Verificar se j√° existe empresa no NOVO banco
        const { data: company, error: companyError } = await supabase
          .from('companies')
          .select('id')
          .eq('company_name', 'Minha Empresa')
          .single();
        
        if (companyError && companyError.code !== 'PGRST116') {
          // PGRST116 = "No rows found" - √© esperado se n√£o existir
          console.error('Erro ao buscar empresa:', companyError);
          throw companyError;
        }
        
        if (company) {
          // Empresa j√° existe - verificar se usu√°rio admin j√° existe
          const { data: existingUser } = await supabase
            .from('users')
            .select('id')
            .eq('company_id', company.id)
            .eq('username', 'admin')
            .single();
          
          if (!existingUser) {
            // Criar usu√°rio admin
            await supabase.from('users').insert({
              company_id: company.id,
              username: 'admin',
              password_hash: 'admin123',
              role: 'admin'
            });
          }
          
          alert('‚úÖ Sistema j√° ativado anteriormente!\n\nUsu√°rio: admin\nSenha: admin123\n\nClique em "Login" para entrar.');
          showTab('login');
          return;
        }
        
        // 2. Criar NOVA empresa
        console.log('üè¢ Criando nova empresa...');
        const { data: newCompany, error: insertError } = await supabase
          .from('companies')
          .insert({ 
            company_name: 'Minha Empresa',
            cnpj: '00.000.000/0000-00',
            phone: '(84) 99999-9999',
            email: 'contato@tanquedigital.com.br'
          })
          .select()
          .single();
        
        if (insertError) {
          console.error('Erro ao criar empresa:', insertError);
          throw insertError;
        }
        
        // 3. Criar usu√°rio admin
        console.log('üë§ Criando usu√°rio admin...');
        const { error: userError } = await supabase.from('users').insert({
          company_id: newCompany.id,
          username: 'admin',
          password_hash: 'admin123',
          full_name: 'Administrador Principal',
          role: 'admin',
          is_active: true
        });
        
        if (userError) {
          console.error('Erro ao criar usu√°rio:', userError);
          throw userError;
        }
        
        // 4. Marcar chave como usada (se tabela activation_keys existir)
        try {
          const { error: keyError } = await supabase
            .from('activation_keys')
            .update({ is_used: true })
            .eq('serial_key', 'TQD-DEMO-2024');
          
          if (keyError) {
            console.warn('Aviso (pode ignorar):', keyError.message);
          }
        } catch (keyErr) {
          console.warn('Tabela activation_keys n√£o encontrada, continuando...');
        }
        
        alert('‚úÖ ATIVA√á√ÉO CONCLU√çDA COM SUCESSO!\n\n' +
              'Usu√°rio: admin\n' +
              'Senha: admin123\n\n' +
              'Clique em "Login" para acessar o sistema.');
        
        console.log('üéâ Ativa√ß√£o completa! Empresa ID:', newCompany.id);
        showTab('login');
        
      } catch (err) {
        console.error('‚ùå Erro completo na ativa√ß√£o:', err);
        
        // Mensagens amig√°veis para erros comuns
        if (err.message.includes('Failed to fetch') || err.message.includes('CORS')) {
          alert('‚ùå ERRO DE CONEX√ÉO!\n\n' +
                '1. Verifique se configurou CORS no Supabase\n' +
                '2. As credenciais est√£o corretas?\n' +
                '3. Banco de dados existe?');
        } else if (err.message.includes('relation') && err.message.includes('does not exist')) {
          alert('‚ùå TABELAS N√ÉO ENCONTRADAS!\n\n' +
                'Execute o script SQL no novo banco:\n' +
                '1. Acesse Supabase ‚Üí SQL Editor\n' +
                '2. Cole o script completo\n' +
                '3. Clique em RUN');
        } else {
          alert('‚ùå Erro na ativa√ß√£o. Verifique o console (F12) para detalhes.');
        }
      }
    }
    // Tecla Enter
    document.getElementById('password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });
    
    document.getElementById('serialKey').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') activate();
    });
  </script>
</body>
</html>
