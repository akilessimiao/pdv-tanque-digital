<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDV Tanque Digital - Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    :root {
      --primary: #1a73e8;
      --primary-dark: #0d62d9;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --dark: #212529;
      --light: #f8f9fa;
      --gray: #6c757d;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      background: white;
      border-radius: 16px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, #1a73e8, #6f42c1);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--dark);
      text-decoration: none;
    }

    .logo-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      box-shadow: 0 4px 15px rgba(26, 115, 232, 0.3);
    }

    .logo h1 {
      font-size: 22px;
      font-weight: 700;
      color: var(--dark);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.2);
    }

    .user-details {
      text-align: right;
    }

    .user-name {
      font-weight: 600;
      color: var(--dark);
      font-size: 16px;
    }

    .user-role {
      color: var(--gray);
      font-size: 14px;
      font-weight: 500;
    }

    .logout {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 10px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
    }

    .logout:hover {
      background: #c82333;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(220, 53, 69, 0.3);
    }

    .main {
      max-width: 1400px;
      margin: 0 auto;
    }

    .welcome {
      font-size: 28px;
      color: var(--dark);
      font-weight: 700;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .welcome i {
      color: var(--primary);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      border-top: 4px solid var(--primary);
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 80px;
      height: 80px;
      background: rgba(26, 115, 232, 0.05);
      border-radius: 50%;
    }

    .stat-card::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), transparent);
    }

    .card-icon {
      font-size: 48px;
      margin-bottom: 20px;
      color: var(--primary);
      text-align: center;
    }

    .card-label {
      font-size: 16px;
      color: var(--gray);
      margin-bottom: 10px;
      font-weight: 500;
    }

    .card-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
      text-align: center;
      margin: 10px 0;
    }

    .card-footer {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      color: var(--gray);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .action-btn {
      background: white;
      border: none;
      border-radius: 16px;
      padding: 25px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .action-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
    }

    .action-btn i {
      font-size: 32px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .action-btn .btn-text {
      color: var(--dark);
      font-weight: 600;
    }

    .action-btn .btn-subtext {
      color: var(--gray);
      font-size: 14px;
      font-weight: 500;
    }

    .action-btn.cash i {
      background: linear-gradient(135deg, var(--success) 0%, #1e7e34 100%);
    }

    .action-btn.products i {
      background: linear-gradient(135deg, #6f42c1 0%, #563d7c 100%);
    }

    .action-btn.reports i {
      background: linear-gradient(135deg, var(--warning) 0%, #d39e00 100%);
    }

    .recent-sales {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      margin-top: 40px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }

    .section-header h2 {
      font-size: 22px;
      color: var(--dark);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-header h2 i {
      color: var(--primary);
    }

    .btn-view-all {
      background: var(--light);
      color: var(--primary);
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-view-all:hover {
      background: #e0e7ff;
      color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .table-container {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table thead {
      background: #f8f9fa;
    }

    .data-table th {
      padding: 16px 15px;
      text-align: left;
      font-weight: 600;
      color: var(--dark);
      font-size: 15px;
      border-bottom: 2px solid #dee2e6;
    }

    .data-table td {
      padding: 15px;
      border-bottom: 1px solid #eee;
      color: var(--gray);
      font-size: 15px;
    }

    .data-table tbody tr:hover {
      background: #f8f9fa;
      transition: background 0.2s;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      text-align: center;
    }

    .status-badge.success {
      background: #d4edda;
      color: #155724;
    }

    .status-badge.pending {
      background: #fff3cd;
      color: #856404;
    }

    .empty-row {
      text-align: center;
      padding: 40px;
      color: #999;
      font-style: italic;
      font-size: 16px;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .quick-actions {
        grid-template-columns: 1fr;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      .user-info {
        width: 100%;
        justify-content: space-between;
      }

      .welcome {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="#" class="logo">
      <div class="logo-icon">
        <i class="fas fa-gas-pump"></i>
      </div>
      <h1>PDV Tanque Digital</h1>
    </a>
    
    <div class="user-info">
      <div class="user-details">
        <div class="user-name" id="userName">Carregando...</div>
        <div class="user-role" id="userRole">-</div>
      </div>
      <button class="logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </div>
  </div>

  <div class="main">
    <h1 class="welcome">
      <i class="fas fa-chart-line"></i> Dashboard
    </h1>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="card-icon">
          <i class="fas fa-shopping-cart"></i>
        </div>
        <div class="card-label">Vendas Hoje</div>
        <div class="card-value" id="salesCount">0</div>
        <div class="card-footer">
          <i class="fas fa-arrow-up"></i>
          <span id="salesTrend">+0% em relação a ontem</span>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="card-icon">
          <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="card-label">Caixa</div>
        <div class="card-value" id="cashStatus">Fechado</div>
        <div class="card-footer">
          <i class="fas fa-clock"></i>
          <span id="cashLastUpdate">Última atualização: -</span>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="card-icon">
          <i class="fas fa-box"></i>
        </div>
        <div class="card-label">Produtos</div>
        <div class="card-value" id="productCount">0</div>
        <div class="card-footer">
          <i class="fas fa-exclamation-triangle"></i>
          <span id="lowStock">0 em baixa</span>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="card-icon">
          <i class="fas fa-warehouse"></i>
        </div>
        <div class="card-label">Estoque</div>
        <div class="card-value" id="stockValue">R$ 0,00</div>
        <div class="card-footer">
          <i class="fas fa-sync"></i>
          <span>Atualizado agora</span>
        </div>
      </div>
    </div>
    
    <div class="quick-actions">
      <button class="action-btn" onclick="window.location.href='sales.html'">
        <i class="fas fa-cash-register"></i>
        <div class="btn-text">Nova Venda</div>
        <div class="btn-subtext">F2 para iniciar</div>
      </button>
      
      <button class="action-btn products" onclick="alert('Cadastro de produtos em desenvolvimento - disponível em 48h')">
        <i class="fas fa-boxes"></i>
        <div class="btn-text">Produtos</div>
        <div class="btn-subtext">Gerencie seu estoque</div>
      </button>
      
      <button class="action-btn cash" onclick="openCash()">
        <i class="fas fa-door-open"></i>
        <div class="btn-text">Caixa</div>
        <div class="btn-subtext">Abertura e fechamento</div>
      </button>
      
      <button class="action-btn reports" onclick="alert('Relatórios em desenvolvimento - disponível em 48h')">
        <i class="fas fa-file-invoice"></i>
        <div class="btn-text">Relatórios</div>
        <div class="btn-subtext">Vendas e estoque</div>
      </button>
    </div>
    
    <div class="recent-sales">
      <div class="section-header">
        <h2><i class="fas fa-history"></i> Últimas Vendas</h2>
        <a href="#" class="btn-view-all">
          <i class="fas fa-eye"></i> Ver todas
        </a>
      </div>
      
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Cupom</th>
              <th>Cliente</th>
              <th>Operador</th>
              <th>Data/Hora</th>
              <th>Valor</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="recentSales">
            <tr>
              <td colspan="6" class="empty-row">
                <i class="fas fa-shopping-cart" style="font-size: 36px; color: #ced4da; margin-bottom: 15px;"></i>
                <p>Nenhuma venda recente</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://wohhcexqaqpfokhuvkqk.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_q7PLJV2NAyptuce8vtSSpQ_4WcP6kcd';
    const supabase = window.supabase.create({ supabaseUrl: SUPABASE_URL, supabaseKey: SUPABASE_ANON_KEY });

    if (!localStorage.getItem('userId')) {
      window.location.href = 'index.html';
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Carregar dados do usuário
      document.getElementById('userName').textContent = localStorage.getItem('username');
      document.getElementById('userRole').textContent = localStorage.getItem('role') === 'admin' ? 'Administrador' : 'Operador';
      
      // Carregar estatísticas
      await loadDashboardStats();
      setupEventListeners();
    });

    async function loadDashboardStats() {
      const companyId = localStorage.getItem('companyId');
      const today = new Date().toISOString().split('T')[0];
      
      // Vendas de hoje
      const {  sales } = await supabase
        .from('sales')
        .select('total_amount, customer_name, customer_document')
        .eq('company_id', companyId)
        .gte('created_at', today);
      
      if (sales && sales.length > 0) {
        document.getElementById('salesCount').textContent = sales.length;
        const total = sales.reduce((sum, sale) => sum + parseFloat(sale.total_amount), 0);
        document.getElementById('salesTrend').textContent = `+${Math.round((sales.length / 5) * 100)}% em relação a ontem`;
      }
      
      // Status do caixa
      const {  cash } = await supabase
        .from('cash_registers')
        .select('opening_balance, opened_at')
        .eq('company_id', companyId)
        .eq('is_open', true)
        .single();
      
      if (cash) {
        document.getElementById('cashStatus').textContent = 'Aberto';
        document.getElementById('cashStatus').style.color = '#28a745';
        document.getElementById('cashLastUpdate').textContent = `Última atualização: ${new Date(cash.opened_at).toLocaleTimeString('pt-BR')}`;
      } else {
        document.getElementById('cashStatus').textContent = 'Fechado';
        document.getElementById('cashStatus').style.color = '#dc3545';
      }
      
      // Contagem de produtos
      const {  products } = await supabase
        .from('products')
        .select('id, stock')
        .eq('company_id', companyId);
      
      if (products) {
        document.getElementById('productCount').textContent = products.length;
        const lowStock = products.filter(p => p.stock < 5).length;
        document.getElementById('lowStock').textContent = `${lowStock} em baixa`;
      }
      
      // Valor do estoque
      const {  stockValue } = await supabase
        .from('products')
        .select('price, stock')
        .eq('company_id', companyId);
      
      if (stockValue) {
        const total = stockValue.reduce((sum, p) => sum + (parseFloat(p.price) * p.stock), 0);
        document.getElementById('stockValue').textContent = formatCurrency(total);
      }
      
      // Últimas vendas
      const {  recentSales } = await supabase
        .from('sales')
        .select('*, users(username)')
        .eq('company_id', companyId)
        .order('created_at', { ascending: false })
        .limit(5);
      
      if (recentSales && recentSales.length > 0) {
        const tbody = document.getElementById('recentSales');
        tbody.innerHTML = recentSales.map(sale => `
          <tr>
            <td>${sale.receipt_serial || '---'}</td>
            <td>${sale.customer_name || '-'}</td>
            <td>${sale.users?.username || '-'}</td>
            <td>${formatDateTime(sale.created_at)}</td>
            <td>${formatCurrency(sale.total_amount)}</td>
            <td><span class="status-badge success">Concluída</span></td>
          </tr>
        `).join('');
      }
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(value);
    }

    function formatDateTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function setupEventListeners() {
      document.addEventListener('keydown', (e) => {
        if (e.key === 'F2') {
          window.location.href = 'sales.html';
        }
      });
    }

    function openCash() {
      const isOpen = document.getElementById('cashStatus').textContent === 'Aberto';
      if (isOpen) {
        window.location.href = 'cash-close.html';
      } else {
        window.location.href = 'cash-open.html';
      }
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>
